@model FriendsPageViewModel
@using FaceLook.Common.Enums
@using FaceLook.Common.Constants

@{
	ViewData["Title"] = "Friends";
}

<div class="container-glass">
	<div class="d-flex justify-content-between align-items-center mb-4">
		<h1 class="text-white">
			<i class="bi bi-people-fill"></i> Friends
		</h1>
		<span class="badge bg-primary fs-6">
			@Model.AcceptedFriends.Count() friends
		</span>
	</div>

	@if (TempData[ErrorConstants.ErrorKey] != null)
	{
		<div class="alert alert-danger glass-card mb-3">
			<i class="bi bi-exclamation-triangle"></i> @TempData[ErrorConstants.ErrorKey]
		</div>
	}
	@if (TempData["SuccessMessage"] != null)
	{
		<div class="alert alert-success glass-card mb-3">
			<i class="bi bi-check-circle"></i> @TempData["SuccessMessage"]
		</div>
	}

	<!-- Add Friend Card -->
	<div class="glass-card mb-4">
		<h5 class="text-white mb-3"><i class="bi bi-person-plus-fill"></i> Add a Friend</h5>
		@await Html.PartialAsync("_SendFriendRequestPartial", Model.SendRequest)
	</div>

	<!-- Pending Requests Section -->
	@if (Model.PendingRequests.Any())
	{
		<div class="glass-card mb-4">
			<h5 class="text-white mb-3">
				<i class="bi bi-bell-fill text-warning"></i>
				Friend Requests
				<span class="badge bg-warning text-dark ms-2">@Model.PendingRequests.Count()</span>
			</h5>
			<div class="row g-3">
				@foreach (var request in Model.PendingRequests)
				{
					<div class="col-md-6 col-lg-4">
						<div class="glass-card h-100">
							<div class="d-flex align-items-center mb-3">
								<div class="rounded-circle bg-primary d-flex align-items-center justify-content-center me-3"
									 style="width:48px;height:48px;font-size:1.4rem;">
									<i class="bi bi-person-fill text-white"></i>
								</div>
								<div>
									<div class="text-white fw-bold">@request.FriendUserName</div>
									<div class="text-white-50 small">@request.FriendEmail</div>
								</div>
							</div>
							<div class="d-flex gap-2">
								<form asp-action="Accept" asp-route-id="@request.FriendshipId" method="post" class="flex-fill">
									@Html.AntiForgeryToken()
									<button type="submit" class="btn btn-success btn-sm w-100">
										<i class="bi bi-check-lg"></i> Accept
									</button>
								</form>
								<form asp-action="Decline" asp-route-id="@request.FriendshipId" method="post" class="flex-fill">
									@Html.AntiForgeryToken()
									<button type="submit" class="btn btn-outline-danger btn-sm w-100">
										<i class="bi bi-x-lg"></i> Decline
									</button>
								</form>
							</div>
						</div>
					</div>
				}
			</div>
		</div>
	}

	<!-- Sent Requests Section -->
	@if (Model.SentRequests.Any())
	{
		<div class="glass-card mb-4">
			<h5 class="text-white mb-3">
				<i class="bi bi-clock-history text-info"></i> Sent Requests
				<span class="badge bg-info text-dark ms-2">@Model.SentRequests.Count()</span>
			</h5>
			<div class="row g-3">
				@foreach (var request in Model.SentRequests)
				{
					<div class="col-md-6 col-lg-4">
						<div class="glass-card h-100 d-flex align-items-center justify-content-between">
							<div class="d-flex align-items-center">
								<div class="rounded-circle bg-info d-flex align-items-center justify-content-center me-3"
									 style="width:44px;height:44px;font-size:1.2rem;">
									<i class="bi bi-person-fill text-white"></i>
								</div>
								<div>
									<div class="text-white fw-bold">@request.FriendUserName</div>
									<div class="text-white-50 small">Pending response...</div>
								</div>
							</div>
							<form asp-action="Remove" asp-route-id="@request.FriendshipId" method="post">
								@Html.AntiForgeryToken()
								<button type="submit" class="btn btn-sm btn-outline-secondary" title="Cancel request">
									<i class="bi bi-x"></i>
								</button>
							</form>
						</div>
					</div>
				}
			</div>
		</div>
	}

	<!-- Friends List -->
	<div class="glass-card">
		<h5 class="text-white mb-3">
			<i class="bi bi-person-check-fill text-success"></i> Your Friends
		</h5>
		@if (!Model.AcceptedFriends.Any())
		{
			<div class="text-center py-5 text-white-50">
				<i class="bi bi-people" style="font-size:3rem;"></i>
				<p class="mt-3">No friends yet. Send a request above!</p>
			</div>
		}
		else
		{
			<div class="row g-3">
				@foreach (var friend in Model.AcceptedFriends)
				{
					<div class="col-md-6 col-lg-4">
						<div class="glass-card h-100">
							<div class="d-flex align-items-center mb-3">
								<div class="rounded-circle bg-success d-flex align-items-center justify-content-center me-3"
									 style="width:48px;height:48px;font-size:1.4rem;">
									<i class="bi bi-person-fill text-white"></i>
								</div>
								<div class="flex-grow-1">
									<div class="text-white fw-bold">@friend.FriendUserName</div>
									<div class="text-white-50 small">@friend.FriendEmail</div>
								</div>
							</div>
							<div class="d-flex gap-2">
								<a asp-controller="Messages"
									   asp-action="Create"
									   asp-route-receiverEmail="@friend.FriendEmail"
									   class="btn glass-button btn-sm flex-fill">
									<i class="bi bi-chat-dots"></i> Message
								</a>
								<button type="button"
										class="btn btn-sm btn-outline-danger remove-friend-btn"
										data-id="@friend.FriendshipId"
										data-name="@friend.FriendUserName"
										title="Remove friend">
									<i class="bi bi-person-dash"></i>
								</button>
							</div>
						</div>
					</div>
				}
			</div>
		}
	</div>
</div>

<!-- Remove Friend Modal -->
<div id="removeFriendModal" class="modal-glass" style="display:none; position:fixed; z-index:9999; left:0; top:0; width:100%; height:100%;">
	<div style="display:flex; align-items:center; justify-content:center; height:100%;">
		<div class="glass-card" style="max-width:400px; text-align:center;">
			<div class="mb-3">
				<i class="bi bi-person-dash" style="font-size:3rem; color:#f5576c;"></i>
			</div>
			<h4 class="text-white mb-2">Remove Friend?</h4>
			<p class="text-white" id="removeFriendName"></p>
			<form asp-action="Remove" method="post" id="removeFriendForm">
				@Html.AntiForgeryToken()
				<input type="hidden" name="id" id="removeFriendId" />
				<div class="mt-4 d-flex justify-content-center gap-2">
					<button type="button" onclick="closeRemoveModal()" class="btn glass-button">
						<i class="bi bi-x-circle"></i> Cancel
					</button>
					<button type="submit" class="btn btn-danger">
						<i class="bi bi-person-dash"></i> Remove
					</button>
				</div>
			</form>
		</div>
	</div>
</div>

@section Scripts {
	@{
		await Html.RenderPartialAsync("_ValidationScriptsPartial");
	}
	<script>
		function closeRemoveModal() {
			document.getElementById('removeFriendModal').style.display = 'none';
		}

		document.addEventListener('click', e => {
			const btn = e.target.closest('.remove-friend-btn');
			if (btn) {
				document.getElementById('removeFriendId').value = btn.dataset.id;
				document.getElementById('removeFriendName').textContent =
					`Are you sure you want to remove ${btn.dataset.name} from your friends?`;
				document.getElementById('removeFriendModal').style.display = 'block';
			}
		});

		window.addEventListener('click', e => {
			if (e.target === document.getElementById('removeFriendModal')) closeRemoveModal();
		});
	</script>
}
