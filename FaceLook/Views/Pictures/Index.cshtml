@model IEnumerable<PictureViewModel>

@section Styles {
	<link rel="stylesheet" href="~/css/pictures.css" />
}

@{
	var pictureControllerName = ControllersExtensions.GetControllerName<PicturesController>();
	ViewData["Title"] = "Photo Gallery";
}

<div class="container-glass">
	<div class="d-flex justify-content-between align-items-center mb-4">
		<h1 class="text-white">
			<i class="bi bi-images"></i> Photo Gallery
		</h1>
		<a href="@this.Url.Action(action: nameof(PicturesController.Upload), controller: pictureControllerName)"
			   class="btn glass-button">
			<i class="bi bi-cloud-upload"></i> Upload Photo
		</a>
	</div>

	@if (TempData[PictureConstants.PictureMessageKey] != null)
	{
		<div class="alert alert-success glass-card">
			<i class="bi bi-check-circle"></i> @TempData[PictureConstants.PictureMessageKey]
		</div>
	}

	else if (TempData[PictureConstants.PictureErrorKey] != null)
	{
		<div class="alert alert-danger glass-card">
			<i class="bi bi-exclamation-triangle"></i> @TempData[PictureConstants.PictureMessageKey]
		</div>
	}

	@if (Model.Count() == 0)
	{
		<div class="glass-card text-center">
			<div class="mb-3">
				<i class="bi bi-image" style="font-size:4rem; color:white;"></i>
			</div>
			<h3 class="text-white">No photos yet</h3>
			<p class="text-white">Start sharing your moments by uploading your first photo!</p>
			<a href="@this.Url.Action(action: nameof(PicturesController.Upload), controller: pictureControllerName)"
				   class="btn glass-button mt-3">
				<i class="bi bi-cloud-upload"></i> Upload Your First Photo
			</a>
		</div>
	}
	else
	{
		<div class="picture-gallery">
			@foreach (var pictureViewModel in Model)
			{
				<div class="picture-card user-picture-container" data-full="@pictureViewModel.SasUrl">
					<img src="@pictureViewModel.SasUrl"
						 alt="User picture"
						 class="user-picture"
						 style="width:100%; height:100%; object-fit:cover; border-radius:15px;" />

					<span class="edit-icon"
						  title="Edit Photo"
						  data-edit="@pictureViewModel.Name"
						  tabindex="0">
						<i class="bi bi-pencil-fill"></i>
					</span>

					<ul class="picture-actions-list" style="display:none;">
						<li>
							<button type="button"
									class="dropdown-item text-danger js-delete-trigger"
									data-picture-id="@pictureViewModel.Id"
									data-picture-name="@pictureViewModel.Name"
									style="width:100%; text-align:left; padding:8px 16px;">
								<i class="bi bi-trash"></i> Delete Photo
							</button>
						</li>
					</ul>
				</div>
			}
		</div>
	}
</div>

<partial name="_GenericModalPartial" model="string.Empty" />

<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered">
		<div class="modal-content modal-picture-content">
			<div class="modal-header modal-picture-header">
				<h5 class="modal-title text-white" id="deleteConfirmModalLabel">
					<i class="bi bi-trash"></i> Delete Photo
				</h5>
				<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body text-white">
				Are you sure you want to delete <strong id="deletePhotoName"></strong>? This action cannot be undone.
			</div>
			<div class="modal-footer" style="border-top: 1px solid rgba(255,255,255,0.15);">
				<button type="button" class="btn glass-button" data-bs-dismiss="modal">
					<i class="bi bi-x-lg"></i> Cancel
				</button>
				<form id="deleteConfirmForm" method="post"
					  asp-controller="Pictures"
					  asp-action="@nameof(PicturesController.Delete)">
					<input type="hidden" id="deleteConfirmPictureId" name="pictureId" value="" />
					<button type="submit" class="btn btn-danger">
						<i class="bi bi-trash"></i> Yes, Delete
					</button>
				</form>
			</div>
		</div>
	</div>
</div>

@section Scripts {
	<script>
		document.addEventListener('DOMContentLoaded', function () {
			const pictureContainers = document.querySelectorAll('.user-picture-container');
			const editIcons = document.querySelectorAll('.edit-icon');
			const modalImageContainer = document.getElementById('modalContainer');
			const previewModal = new bootstrap.Modal(document.getElementById('genericModal'));
			const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
			const deletePhotoName = document.getElementById('deletePhotoName');
			const deleteConfirmPictureId = document.getElementById('deleteConfirmPictureId');

			pictureContainers.forEach(container => {
				container.querySelector('.user-picture').addEventListener('click', function (e) {
					e.stopPropagation();
					const imgUrl = container.getAttribute('data-full');
					if (modalImageContainer) {
						modalImageContainer.innerHTML =
							`<img src="${imgUrl}" class="large-picture" alt="Large picture" />`;
					}
					previewModal.show();
				});
			});

			editIcons.forEach(editIconSpan => {
				editIconSpan.addEventListener('click', function (e) {
					e.stopPropagation();
					e.preventDefault();

					document.querySelectorAll('.picture-actions-list').forEach(list => {
						if (list !== this.parentElement.querySelector('.picture-actions-list')) {
							list.style.display = 'none';
						}
					});

					const actionsList = this.parentElement.querySelector('.picture-actions-list');
					if (actionsList) {
						const isVisible = actionsList.style.display === 'block';
						actionsList.style.display = isVisible ? 'none' : 'block';
					}
				});
			});

			document.querySelectorAll('.js-delete-trigger').forEach(btn => {
				btn.addEventListener('click', function (e) {
					e.stopPropagation();
					deletePhotoName.textContent = this.dataset.pictureName;
					deleteConfirmPictureId.value = this.dataset.pictureId;
					document.querySelectorAll('.picture-actions-list').forEach(list => list.style.display = 'none');
					deleteModal.show();
				});
			});

			document.addEventListener('click', function (e) {
				if (!e.target.closest('.user-picture-container')) {
					document.querySelectorAll('.picture-actions-list').forEach(list => {
						list.style.display = 'none';
					});
				}
			});
		});
	</script>
}
